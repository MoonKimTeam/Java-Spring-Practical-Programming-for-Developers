# 레이어드 아키텍처

## 레이어드 아키텍처의 최소 조건

레이어드 아키텍처는 애플리케이션을 레이어로 나누고 각 레이어에 역할을 정합니다. 대표적인 레이어에는 프레젠테이션, 비즈니스, 인프라스트럭처 같은 레이어가 있습니다.  
누군가는 레이어드 아키텍처를 헥사고날 아키텍처 수준으로 사용합니다.  
반면 누군가는 이 아키텍처를 폴더를 관리하는 수준으로밖에 사용하지 못합니다.  
**레이어드 아키텍처에서 중요한 것은 레이어 유형을 외우고 그에 맞게 컴포넌트를 배치하는 것이 아닙니다. 그보다 다음과 같은 사항을 지키는 것이 중요합니다.**

1. 레이어 구조를 사용한다.
2. 레이어 간 의존 방향은 단방향으로 유지한다.
3. 레이어 간 통신은 인접한 레이어에서만 이뤄지게 한다.

> 아키텍처는 정책과 제약 조건을 이용해 목적을 달성합니다.

아키텍처는 제약 조건을 이용해 개발자가 해도 되는 것과 하지 말아야 하는 것을 결정합니다.  
더 나아가, 해서는 안 되는 일이 개발 단계에서 일어나지 않게 원천적으로 차단합니다.  
아키텍처는 '정책과 제약을 정하는 과정'이라고 해석합니다.  
그래서 아키텍처를 적용한다는 것은 제약 조건을 만든다는 것이며, 이를 프로젝트에 적용해 코드를 일관되고 논리적으로 만드는 것이라 생각합니다.

## 잘못된 레이어드 아키텍처

> 여러분에게 계정(Account) 시스템의 백엔드를 만들어 달라고 했을 때 여러분은 어떤 작업부터 하실 건가요?

- 유형 1： JPA 엔티티 우선 JPA 엔티티를 어떻게 만들지 고민합니다.
- 유형 2： API 엔드포인트 우선. 계정 시스템의 API 엔드포인트를 어떻게 만들지 고민합니다

### JPA 엔티티 우선 접근

JPA 엔티티 우선 유형이란 '계정 시스템을 만들어 달라'라는 요청에 데이터베이스 테이블을 어떻게 만들지 고민하거나 JPA 엔티티가 어떻게 생겨야 하는지 고민했다는 의미입니다.  
대부분의 개발자가 데이터 모델링이라는 이유로 JPA 엔티티나 데이터베이스의 테이블을 미리 작성합니다.  
이러한 접근 방식은 전혀 객체지향스럽지 않습니다. 왜냐하면 '데이터 구현을 어떤 식으로 하겠다', DDL을 어떤 식으로 작성하겠다' 같은 대답은 데이터 위주의 사고 방식을 하는 것이기 때문입니다.

**'잘못된 레이어드 아키텍처'에 익숙한 사람일수록 이처럼 JPA나 데이터베이스를 우선시하는 방향으로 생각하게 되는 경우가 많습니다.**  
대다수의 스프링 개발자에게 레이어드 아키텍처가 무엇인지 떠올려 보라고 하면 보통 다음과 같은 그림을 떠올립니다.

<img width="422" height="357" alt="Image" src="https://github.com/user-attachments/assets/b6499def-cb87-430a-a64f-131a6cf41f04" />

잘못된 레이어드 아키텍처는 레이어를 지나치게 추상화합니다. 그래서 각 레이어가 무엇을 설명하고 싶은지 알 수 없습니다.  
다른 한편으로 레이어에 대응하는 스프링 컴포넌트는 또 구체적으로 정해져 있습니다.  
이러한 인지 모델을 갖고 시스템을 개발하면 많은 문제가 발생합니다. 대표적인 문제가 지금처럼 데이터베이스 위주의 사고를 하게 된다는 것입니다.

가장 하단에 위치하는 레이어가 인프라스트럭처 레이어이기 때문에 대다수의 개발자가 이 레이어를 가장 먼저 만들려고 합니다.  
인프라스트럭처 레이어를 먼저 만들고, 그다음 비즈니스를 만들고, API 엔드포인트를 열어 서비스를 실행하도록 시스템을 만들려고 하는 것입니다.
**이런 방식으로는 상위 레이어인 비즈니스 레이어의 서비스 컴포넌트는 JPA 엔티티와 그 기반이 만들어지기 전까지 아무런 작업을 시작할 수 없습니다.**  
그래서 이러한 접근법으로 만들어진 애플리케이션은 요구사항에 맞는 데이터베이스가 선정되는 것이 아니라 데이터베이스에 맞는 기능을 개발하는 방향으로 발전할 수밖에 없습니다.

### API 엔드포인트 우선 접근

이런 접근 방식은 결국 시스템이 특정 프레임워크에 종속되는 결과를 낳습니다. 좀 더 쉽게 말해서 프로젝트가 스프링 프레임워크에 종속될 수 있습니다.  
우리의 시스템은 API 서버뿐만 아니라 다양한 유형의 서버가 될 수 있습니다.  
웹소켓용 서버가 될수도 있고, 원격 호출을 위한 gRPC 서버가 될 수도 있고, 메시지 큐의 컨슈머가 될 수도 있습니다.  
결국 API 엔드포인트를 고민하는 것은 도메인 요구사항이 무엇인지 파악하는 데 도움을 줄 수 있을 뿐, 딱 거기까지입니다.

### 본질을 다시 생각하기

진정한 의미의 백엔드 개발자는 스프링이나 JPA 없이도 성립할 수 있는 애플리케이션을 만들 수 있어야 합니다.  
애플리케이션이 특정 기술에 종속되지 않아야 한다는 것입니다.  
그러기 위해서는 순수 자바 코드로 객체지향적인 애플리케이션을 먼저 만들 수 있어야 한다는 의미입니다. 스프링 같은 웹 프레임워크나 JPA 같은 영속성 라이브러리는 그 애플리케이션에 얹힐 뿐이어야 합니다.

## 진화하는 아키텍처

시스템 개발의 첫 시작을 도메인으로 둬야합니다.  
애플리케이션에서 가장 중요한 것은 도메인입니다. 그래서 시스템 개발은 도메인 분석과 도메인 개발에서 출발해야 합니다.

### 인지 모델 변경하기

도메인을 개발하려면 비즈니스 레이어부터 개발하면 됩니다.  
그런데 뭔가 이상하다는 생각이 들 수 있습니다. 일반적으로 비즈니스 레이어에 대응하는 컴포넌트는 스프링의 서비스 컴포넌트입니다.  
그렇다면 비즈니스 레이어부터 개발하라는 이야기는 스프링 서비스 컴포넌트부터 개발하라는 이야기일까요?  
이러한 오해는 비즈니스 레이어를 잘못 해석할 때 발생합니다, 서비스 컴포넌트는 분명 비즈니스 레이어에 속하는 컴포넌트이지만, '비즈니스 레이어 = 서비스 컴포넌트'인 것은 아닙니다.  
지금껏 계속 설명했듯이 도메인이란 비즈니스 영역입니다. 그러니까 도메인은 비즈니스 레이어에 포함되는 개념인 것이 맞습니다.

### JPA와의 결합 끊기

시간이 10년 정도 흘러서 JPA를 대체할 만한 획기적인 라이브러리가 나왔다고 해봅시다.  
그래서 프로젝트에 사용된 모든 JPA 관련 코드를 시대의 흐름에 맞춰 새로운 라이브러리로 변경하기로 결정했습니다.  
이에 유연하게 대응하기 위해서는 애플리케이션이 영속성 라이브러리 같은 외부 라이브러리에 너무 강결합돼 있어서는 안 됩니다.  
**인프라스트럭처 레이어의 구성이 달라져도 애플리케이션 레이어가 영향을 받지 않는 구조로 애플리케이션을 설계해야 합니다.**
이는 의존성 역전을 사용하여 해결할 수 있습니다.

<img width="607" height="289" alt="Image" src="https://github.com/user-attachments/assets/c332dca8-9a21-4f42-8917-ef63b942d43e" />

## 새로운 접근법

'계정 시스템'을 만들어야 한다면 어디서부터 개발을 시작할 것인지 물었을때, 도메인 레이어부터 개발하면 된다고 이야기 했습니다.  
도메인 레이어부터 개발한다는 것은 명백한 상향식 접근법입니다.  
도메인을 개발하고, 애플리케이션 서비스를 개발하고, 그다음 애플리케이션 서비스가 사용할 인터페이스를 구성합니다.. 그리고 마지막으로 이에 대응하는 컨트롤러, JPA를 만들어 시스템을 완성해야 합니다.  
아키텍처를 암기하는 게 아니라 이해하고 나면 좀 더 넓은 시야를 갖게 될 수 있습니다.  
**아키텍처의 핵심은 생김새가 아닙니다. 어디까지가 어떤 레이어인지, 이게 육각형 모양인지, 팔각형 모양인지가 중요한 것이 아닙니다. 왜 이런 형태를 띠고 있는지가 중요합니다.**

<img width="600" height="406" alt="Image" src="https://github.com/user-attachments/assets/459eb07b-1995-4895-95ea-15968f52a6da" />

## 빈약한 도메인

> ’아키텍처를 변경해 봤지만 큰 차이를 못 느꼈다.’

도메인 레이어를 만들고 비즈니스 로직을 도메인에 최대한 옮겨보고, 인프라스트럭처 레이어와 애플리케이션 레이어에 의존성 역전을 적용해 봤지만 큰 차이를 못 느꼈을 수도 있습니다.  
혹은 오히려 작성해야 하는 코드가 더 늘어나서 불편해졌다고 불만을 토로하기도 합니다.  
**맞습니다. 프로젝트의 성격에 따라 복잡한 아키텍처를 적용하는 것이 더 손해인 경우도 분명 있습니다.**  
데이터를 저장하고 불러오고 수정하는 일밖에 안하는 단순한 도메인에서는, 트랜잭션 스크립트 방식을 이용해서 개발하는 편이 훨씬 나을 수 있습니다.















